<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >


<mapper namespace="com.atguigu.tingshu.album.mapper.AlbumInfoMapper">

    <select id="getUserAlbumPage" resultType="com.atguigu.tingshu.vo.album.AlbumListVo">
        select ai.id albumId,
               ai.album_title,
               ai.cover_url,
               ai.include_track_count,
               ai.is_finished,
               ai.status,
               max(if(stat.stat_type = '0401', stat.stat_num, 0)) playStatNum,
               max(if(stat.stat_type='0402', stat.stat_num, 0)) subscribeStatNum,
               max(if(stat.stat_type='0403', stat.stat_num, 0)) buyStatNum,
               max(if(stat.stat_type='0404', stat.stat_num, 0)) commentStatNum
        from album_info ai inner join album_stat stat
                                      on ai.id = stat.album_id
            <where>
                <if test="vo.userId != null" >
                    user_id = #{vo.userId}
                </if>
                <if test="vo.albumTitle != null and vo.albumTitle != ''">
                    and album_title like concat('%' , #{vo.albumTitle} , '%')
                </if>
                <if test="vo.status != null and vo.status != ''">
                    and status = #{vo.status}
                </if>
             and stat.is_deleted = 0
            </where>

        group by ai.id
        order by ai.id desc

    </select>

    <select id="getAlbumStatVo" resultType="com.atguigu.tingshu.vo.album.AlbumStatVo">
        select
            album_id,
            max(if(stat_type='0401', stat_num, 0)) playStatNum,
            max(if(stat_type='0402', stat_num, 0)) subscribeStatNum,
            max(if(stat_type='0403', stat_num, 0)) buyStatNum,
            max(if(stat_type='0404', stat_num, 0)) commentStatNum
        from album_stat
        where album_id = #{albumId} and is_deleted = 0
    </select>
</mapper>

